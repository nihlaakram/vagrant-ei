# Copyright 2019 WSO2, Inc. (http://wso2.com)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License
# -------------------------------------------------------------------------
# command line arguments
params:
  existing-version: 6.4.0
  new-version: 6.5.0
  existing-version-docs: v6.4.0.1
  new-version-docs: v6.5.0.1
  wso2ei: wso2ei-6.5.0
# files based configurations
files:
  - file_path: README.md
    file_type: txt
    relative_path: ~
    configurations:
      - operation: replace
        current_value: "{$arg.existing-version-docs}"
        new_value: "{$arg.new-version-docs}"
  # integrator-analytics
  # analytics-dashboard - product_provisioner.sh
  - file_path: integrator-analytics/analytics-dashboard/provisioner/product_provisioner.sh
    relative_path: ~
    file_type: txt
    configurations:
      - operation: replace
        current_value: "{$arg.existing-version}"
        new_value: "{$arg.new-version}"
  # analytics-dashboard - deployment.yaml
  - file_path: integrator-analytics/analytics-dashboard/conf/dashboard/deployment.yaml
    relative_path: "{$arg.wso2ei}/wso2/analytics/conf/dashboard/deployment.yaml"
    file_type: yaml
    configurations:
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/jdbcUrl"
        value: "jdbc:mysql://172.28.128.3:3306/WSO2_EI_ANALYTICS_DB?useSSL=false"
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/username"
        value: "root"
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/driverClassName"
        value: "com.mysql.cj.jdbc.Driver"
  # analytics-worker - product_provisioner.sh
  - file_path: integrator-analytics/analytics-worker/provisioner/product_provisioner.sh
    relative_path: ~
    file_type: txt
    configurations:
      - operation: replace
        current_value: "{$arg.existing-version}"
        new_value: "{$arg.new-version}"
  # analytics-worker - deployment.yaml
  - file_path: integrator-analytics/analytics-worker/conf/worker/deployment.yaml
    relative_path: "{$arg.wso2ei}/wso2/analytics/conf/worker/deployment.yaml"
    file_type: yaml
    configurations:
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/jdbcUrl"
        value: "jdbc:mysql://172.28.128.3:3306/WSO2_EI_ANALYTICS_DB?useSSL=false"
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/username"
        value: "root"
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/driverClassName"
        value: "com.mysql.cj.jdbc.Driver"
  # integrator - product_provisioner.sh
  - file_path: integrator-analytics/integrator/provisioner/product_provisioner.sh
    relative_path: ~
    file_type: txt
    configurations:
      - operation: replace
        current_value: "{$arg.existing-version}"
        new_value: "{$arg.new-version}"
  # carbon.xml
  - file_path: integrator-analytics/integrator/conf/carbon.xml
    relative_path: "{$arg.wso2ei}/conf/carbon.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "."
        value:
          |
          <HostName>172.28.128.7</HostName>
      - operation: add
        xpath: "."
        value:
          |
          <MgtHostName>172.28.128.7</MgtHostName>
      - operation: replace
        xpath: "Analytics/ServerURL"
        value: "tcp://172.28.128.5:7612"
      - operation: replace
        xpath: "Analytics/AuthServerURL"
        value: "ssl://172.28.128.5:7712"
  # synapse.properties
  - file_path: integrator-analytics/integrator/conf/synapse.properties
    file_type: txt
    relative_path: "{$arg.wso2ei}/conf/synapse.properties"
    configurations:
      - operation: replace
        current_value: "mediation.flow.statistics.enable=false"
        new_value: "mediation.flow.statistics.enable=true"
      - operation: replace
        current_value: "mediation.flow.statistics.tracer.collect.payloads=false"
        new_value: "mediation.flow.statistics.tracer.collect.payloads=true"
      - operation: replace
        current_value: "mediation.flow.statistics.tracer.collect.properties=false"
        new_value: "mediation.flow.statistics.tracer.collect.properties=true"
      - operation: replace
        current_value: "mediation.flow.statistics.collect.all=false"
        new_value: "mediation.flow.statistics.collect.all=true"
  # axis2.xml
  - file_path: integrator-analytics/integrator/conf/axis2/axis2.xml
    relative_path: "{$arg.wso2ei}/conf/axis2/axis2.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "transportReceiver[@name=\"http\"]"
        value:
          |
          <parameter name="WSDLEPRPrefix" locked="false">http://172.28.128.7:8280</parameter>
      - operation: add
        xpath: "transportReceiver[@name=\"https\"]"
        value:
          |
          <parameter name="WSDLEPRPrefix" locked="false">http://172.28.128.7:8243</parameter>
  # master-datasources.xml
  - file_path: integrator-analytics/integrator/conf/datasources/master-datasources.xml
    relative_path: "{$arg.wso2ei}/conf/datasources/master-datasources.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "datasources"
        value:
          |
          <datasource>
            <name>WSO2_EI_ANALYTICS_DB</name>
            <description>The datasource used for analytics record store</description>
            <definition type="RDBMS">
              <configuration>
                <url>jdbc:mysql://172.28.128.3:3306/WSO2_EI_ANALYTICS_DB?autoReconnect=true</url>
                <username>root</username>
               <password>wso2carbon</password>
                <driverClassName>com.mysql.cj.jdbc.Driver</driverClassName>
                <maxActive>50</maxActive>
                <maxWait>60000</maxWait>
                <validationQuery>SELECT 1</validationQuery>
                <defaultAutoCommit>false</defaultAutoCommit>
                <initialSize>0</initialSize>
                <testWhileIdle>true</testWhileIdle>
                <minEvictableIdleTimeMillis>4000</minEvictableIdleTimeMillis>
                <defaultTransactionIsolation>READ_COMMITTED</defaultTransactionIsolation>
              </configuration>
            </definition>
          </datasource>
  # integrator-bps-analytics
  # analytics-dashboard - product_provisioner.sh
  - file_path: integrator-bps-analytics/analytics-dashboard/provisioner/product_provisioner.sh
    relative_path: ~
    file_type: txt
    configurations:
      - operation: replace
        current_value: "{$arg.existing-version}"
        new_value: "{$arg.new-version}"
  # analytics-dashboard - deployment.yaml
  - file_path: integrator-bps-analytics/analytics-dashboard/conf/dashboard/deployment.yaml
    relative_path: "{$arg.wso2ei}/wso2/analytics/conf/dashboard/deployment.yaml"
    file_type: yaml
    configurations:
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/jdbcUrl"
        value: "jdbc:mysql://172.28.128.3:3306/WSO2_EI_ANALYTICS_DB?useSSL=false"
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/username"
        value: "root"
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/driverClassName"
        value: "com.mysql.cj.jdbc.Driver"
  # analytics-worker - product_provisioner.sh
  - file_path: integrator-bps-analytics/analytics-worker/provisioner/product_provisioner.sh
    relative_path: ~
    file_type: txt
    configurations:
      - operation: replace
        current_value: "{$arg.existing-version}"
        new_value: "{$arg.new-version}"
  # analytics-worker - deployment.yaml
  - file_path: integrator-bps-analytics/analytics-worker/conf/worker/deployment.yaml
    relative_path: "{$arg.wso2ei}/wso2/analytics/conf/worker/deployment.yaml"
    file_type: yaml
    configurations:
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/jdbcUrl"
        value: "jdbc:mysql://172.28.128.3:3306/WSO2_EI_ANALYTICS_DB?useSSL=false"
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/username"
        value: "root"
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/driverClassName"
        value: "com.mysql.cj.jdbc.Driver"
  # business-process - wso2server.sh
  - file_path: integrator-bps-analytics/business-process/bin/wso2server.sh
    relative_path: "{$arg.wso2ei}/wso2/business-process/bin/wso2server.sh"
    file_type: sh
    configurations:
      - operation: "add"
        xpath: "-Dorg.apache.cxf.io.CachedOutputStream.Threshold=104857600"
        value: "    -Dhttpclient.hostnameVerifier=AllowAll \\\n"
      - operation: "add"
        xpath: "-Dhttpclient.hostnameVerifier=AllowAll"
        value: "    -Dorg.opensaml.httpclient.https.disableHostnameVerification=true \\\n"
  # business-process - product_provisioner.sh
  - file_path: integrator-bps-analytics/business-process/provisioner/product_provisioner.sh
    relative_path: ~
    file_type: txt
    configurations:
      - operation: replace
        current_value: "{$arg.existing-version}"
        new_value: "{$arg.new-version}"
  # bps.xml
  - file_path: integrator-bps-analytics/business-process/conf/bps.xml
    relative_path: "{$arg.wso2ei}/wso2/business-process/conf/bps.xml"
    file_type: xml
    configurations:
      - operation: replace
        xpath: "tns:ODESchedulerThreadPoolSize"
        value: "10"
  # carbon.xml
  - file_path: integrator-bps-analytics/business-process/conf/carbon.xml
    relative_path: "{$arg.wso2ei}/wso2/business-process/conf/carbon.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "."
        value:
          |
          <HostName>172.28.128.6</HostName>
      - operation: add
        xpath: "."
        value:
          |
          <MgtHostName>172.28.128.7</MgtHostName>
  # registry.xml
  - file_path: integrator-bps-analytics/business-process/conf/registry.xml
    relative_path: "{$arg.wso2ei}/wso2/business-process/conf/registry.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "."
        value:
          |
          <dbConfig name="WSO2_REGISTRY_DB">
            <dataSource>jdbc/WSO2_REGISTRY_DB</dataSource>
          </dbConfig>
      - operation: add
        xpath: "."
        value:
          |
          <remoteInstance url="https://localhost:8243/registry">
            <id>WSO2_REGISTRY_DB</id>
            <dbConfig>WSO2_REGISTRY_DB</dbConfig>
            <readOnly>false</readOnly>
            <registryRoot>/</registryRoot>
            <enableCache>true</enableCache>
            <cacheId>root@jdbc:mysql://172.28.128.3:3306/WSO2_REGISTRY_DB</cacheId>
          </remoteInstance>
      - operation: add
        xpath: "."
        value:
          |
          <mount path="/_system/config" overwrite="virtual">
            <instanceId>WSO2_REGISTRY_DB</instanceId>
            <targetPath>/_system/business-process/config</targetPath>
          </mount>
      - operation: add
        xpath: "."
        value:
          |
          <mount path="/_system/governance" overwrite="virtual">
            <instanceId>WSO2_REGISTRY_DB</instanceId>
            <targetPath>/_system/governance</targetPath>
          </mount>
      - operation: replace
        xpath: "indexingConfiguration/startIndexing"
        value: "true"
  # user-mgt.xml
  - file_path: integrator-bps-analytics/business-process/conf/user-mgt.xml
    relative_path: "{$arg.wso2ei}/wso2/business-process/conf/user-mgt.xml"
    file_type: xml
    configurations:
      - operation: replace
        xpath: "Realm/Configuration/Property[@name=\"dataSource\"]"
        value: "jdbc/WSO2_USER_DB"
  # activiti-datasources.xml
  - file_path: integrator-bps-analytics/business-process/conf/datasources/activiti-datasources.xml
    relative_path: "{$arg.wso2ei}/wso2/business-process/conf/datasources/activiti-datasources.xml"
    file_type: xml
    configurations:
      - operation: replace
        xpath: "datasources/datasource/definition/configuration/url"
        value: "jdbc:mysql://172.28.128.3:3306/WSO2_ACTIVITY_DB?autoReconnect=true&amp;useSSL=false"
      - operation: replace
        xpath: "datasources/datasource/definition/configuration/username"
        value: "root"
      - operation: replace
        xpath: "datasources/datasource/definition/configuration/driverClassName"
        value: "com.mysql.cj.jdbc.Driver"
  # bps-datasources.xml
  - file_path: integrator-bps-analytics/business-process/conf/datasources/bps-datasources.xml
    relative_path: "{$arg.wso2ei}/wso2/business-process/conf/datasources/bps-datasources.xml"
    file_type: xml
    configurations:
      - operation: replace
        xpath: "datasources/datasource/definition/configuration/url"
        value: "jdbc:mysql://172.28.128.3:3306/WSO2_BUSINESS_PROCESS_DB?autoReconnect=true&amp;useSSL=false"
      - operation: replace
        xpath: "datasources/datasource/definition/configuration/username"
        value: "root"
      - operation: replace
        xpath: "datasources/datasource/definition/configuration/driverClassName"
        value: "com.mysql.cj.jdbc.Driver"
  # master-datasources.xml
  - file_path: integrator-bps-analytics/business-process/conf/datasources/master-datasources.xml
    relative_path: "{$arg.wso2ei}/wso2/business-process/conf/datasources/master-datasources.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "datasources"
        value:
          |
          <datasource>
            <name>WSO2_REGISTRY_DB</name>
            <description>The datasource is used for registry metadata</description>
            <jndiConfig>
                <name>jdbc/WSO2_REGISTRY_DB</name>
            </jndiConfig>
            <definition type="RDBMS">
              <configuration>
                <url>jdbc:mysql://172.28.128.3:3306/WSO2_REGISTRY_DB?autoReconnect=true&amp;useSSL=false</url>
                <username>root</username>
                <password>wso2carbon</password>
                <driverClassName>com.mysql.cj.jdbc.Driver</driverClassName>
                <maxActive>50</maxActive>
                <maxWait>60000</maxWait>
                <testOnBorrow>true</testOnBorrow>
                <validationQuery>SELECT 1</validationQuery>
                <validationInterval>30000</validationInterval>
              </configuration>
            </definition>
          </datasource>
      - operation: add
        xpath: "datasources"
        value:
          |
          <datasource>
            <name>WSO2_USER_DB</name>
            <description>The datasource is used for user mangement and userstore</description>
            <jndiConfig>
                <name>jdbc/WSO2_USER_DB</name>
            </jndiConfig>
            <definition type="RDBMS">
              <configuration>
                <url>jdbc:mysql://172.28.128.3:3306/WSO2_USER_DB?autoReconnect=true&amp;useSSL=false</url>
                <username>root</username>
                <password>wso2carbon</password>
                <driverClassName>com.mysql.cj.jdbc.Driver</driverClassName>
                <maxActive>50</maxActive>
                <maxWait>60000</maxWait>
                <testOnBorrow>true</testOnBorrow>
                <validationQuery>SELECT 1</validationQuery>
                <validationInterval>30000</validationInterval>
              </configuration>
            </definition>
          </datasource>
  # tasks-config.xml
  - file_path: integrator-bps-analytics/business-process/conf/etc/tasks-config.xml
    relative_path: "{$arg.wso2ei}/wso2/business-process/conf/etc/tasks-config.xml"
    file_type: xml
    configurations:
      - operation: replace
        xpath: "datasources/datasource/definition/configuration/url"
        value: "jdbc:mysql://172.28.128.3:3306/WSO2_BUSINESS_PROCESS_DB?autoReconnect=true&amp;useSSL=false"
      - operation: replace
        xpath: "taskServerMode"
        value: "STANDALONE"
# integrator-bps-analytics - product_provisioner.sh
  - file_path: integrator-bps-analytics/integrator/provisioner/product_provisioner.sh
    relative_path: ~
    file_type: txt
    configurations:
      - operation: replace
        current_value: "{$arg.existing-version}"
        new_value: "{$arg.new-version}"
  # carbon.xml
  - file_path: integrator-bps-analytics/integrator/conf/carbon.xml
    relative_path: "{$arg.wso2ei}/conf/carbon.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "."
        value:
          |
          <HostName>172.28.128.7</HostName>
      - operation: add
        xpath: "."
        value:
          |
          <MgtHostName>172.28.128.7</MgtHostName>
      - operation: replace
        xpath: "Axis2Config/HideAdminServiceWSDLs"
        value: "true"
      - operation: replace
        xpath: "Analytics/ServerURL"
        value: "tcp://172.28.128.5:7612"
      - operation: replace
        xpath: "Analytics/AuthServerURL"
        value: "ssl://172.28.128.5:7712"
  # registry.xml
  - file_path: integrator-bps-analytics/integrator/conf/registry.xml
    relative_path: "{$arg.wso2ei}/conf/registry.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "."
        value:
          |
          <dbConfig name="WSO2_REGISTRY_DB">
            <dataSource>jdbc/WSO2_REGISTRY_DB</dataSource>
          </dbConfig>
      - operation: add
        xpath: "."
        value:
          |
          <remoteInstance url="https://localhost:8243/registry">
            <id>WSO2_REGISTRY_DB</id>
            <dbConfig>WSO2_REGISTRY_DB</dbConfig>
            <readOnly>false</readOnly>
            <registryRoot>/</registryRoot>
            <enableCache>true</enableCache>
            <cacheId>root@jdbc:mysql://172.28.128.3:3306/WSO2_REGISTRY_DB</cacheId>
          </remoteInstance>
      - operation: add
        xpath: "."
        value:
          |
          <mount path="/_system/config" overwrite="virtual">
            <instanceId>WSO2_REGISTRY_DB</instanceId>
            <targetPath>/_system/integrator/config</targetPath>
          </mount>
      - operation: add
        xpath: "."
        value:
          |
          <mount path="/_system/governance" overwrite="virtual">
            <instanceId>WSO2_REGISTRY_DB</instanceId>
            <targetPath>/_system/governance</targetPath>
          </mount>
      - operation: replace
        xpath: "indexingConfiguration/startIndexing"
        value: "true"
  # user-mgt.xml
  - file_path: integrator-bps-analytics/integrator/conf/user-mgt.xml
    relative_path: "{$arg.wso2ei}/conf/user-mgt.xml"
    file_type: xml
    configurations:
      - operation: replace
        xpath: "Realm/Configuration/Property[@name=\"dataSource\"]"
        value: "jdbc/WSO2_USER_DB"
  # synapse.properties
  - file_path: integrator-bps-analytics/integrator/conf/synapse.properties
    file_type: txt
    relative_path: "{$arg.wso2ei}/conf/synapse.properties"
    configurations:
      - operation: replace
        current_value: "mediation.flow.statistics.enable=false"
        new_value: "mediation.flow.statistics.enable=true"
      - operation: replace
        current_value: "mediation.flow.statistics.tracer.collect.payloads=false"
        new_value: "mediation.flow.statistics.tracer.collect.payloads=true"
      - operation: replace
        current_value: "mediation.flow.statistics.tracer.collect.properties=false"
        new_value: "mediation.flow.statistics.tracer.collect.properties=true"
      - operation: replace
        current_value: "mediation.flow.statistics.collect.all=false"
        new_value: "mediation.flow.statistics.collect.all=true"
  # axis2.xml
  - file_path: integrator-bps-analytics/integrator/conf/axis2/axis2.xml
    relative_path: "{$arg.wso2ei}/conf/axis2/axis2.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "transportReceiver[@name=\"http\"]"
        value:
          |
          <parameter name="WSDLEPRPrefix" locked="false">http://172.28.128.7:8280</parameter>
      - operation: add
        xpath: "transportReceiver[@name=\"https\"]"
        value:
          |
          <parameter name="WSDLEPRPrefix" locked="false">http://172.28.128.7:8243</parameter>
  # master-datasources.xml
  - file_path: integrator-bps-analytics/integrator/conf/datasources/master-datasources.xml
    relative_path: "{$arg.wso2ei}/conf/datasources/master-datasources.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "datasources"
        value:
          |
          <datasource>
            <name>WSO2_REGISTRY_DB</name>
            <description>The datasource is used for registry metadata</description>
            <jndiConfig>
              <name>jdbc/WSO2_REGISTRY_DB</name>
            </jndiConfig>
            <definition type="RDBMS">
              <configuration>
                <url>jdbc:mysql://172.28.128.3:3306/WSO2_REGISTRY_DB?autoReconnect=true&amp;useSSL=false</url>
                <username>root</username>
                <password>wso2carbon</password>
                <driverClassName>com.mysql.cj.jdbc.Driver</driverClassName>
                <maxActive>80</maxActive>
                <maxWait>60000</maxWait>
                <testOnBorrow>true</testOnBorrow>
                <validationQuery>SELECT 1</validationQuery>
                <validationInterval>30000</validationInterval>
              </configuration>
            </definition>
          </datasource>
      - operation: add
        xpath: "datasources"
        value:
          |
          <datasource>
            <name>WSO2_USER_DB</name>
            <description>The datasource is used for user mangement and userstore</description>
            <jndiConfig>
              <name>jdbc/WSO2_USER_DB</name>
            </jndiConfig>
            <definition type="RDBMS">
              <configuration>
                <url>jdbc:mysql://172.28.128.3:3306/WSO2_USER_DB?autoReconnect=true&amp;useSSL=false</url>
                <username>root</username>
                <password>wso2carbon</password>
                <driverClassName>com.mysql.cj.jdbc.Driver</driverClassName>
                <maxActive>50</maxActive>
                <maxWait>60000</maxWait>
                <testOnBorrow>true</testOnBorrow>
                <validationQuery>SELECT 1</validationQuery>
                <validationInterval>30000</validationInterval>
              </configuration>
            </definition>
          </datasource>
  # integrator-broker-analytics
  # analytics-dashboard - product_provisioner.sh
  - file_path: integrator-broker-analytics/analytics-dashboard/provisioner/product_provisioner.sh
    relative_path: ~
    file_type: txt
    configurations:
      - operation: replace
        current_value: "{$arg.existing-version}"
        new_value: "{$arg.new-version}"
  # analytics-dashboard - deployment.yaml
  - file_path: integrator-broker-analytics/analytics-dashboard/conf/dashboard/deployment.yaml
    relative_path: "{$arg.wso2ei}/wso2/analytics/conf/dashboard/deployment.yaml"
    file_type: yaml
    configurations:
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/jdbcUrl"
        value: "jdbc:mysql://172.28.128.3:3306/WSO2_EI_ANALYTICS_DB?useSSL=false"
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/username"
        value: "root"
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/driverClassName"
        value: "com.mysql.cj.jdbc.Driver"
  # analytics-worker - product_provisioner.sh
  - file_path: integrator-broker-analytics/analytics-worker/provisioner/product_provisioner.sh
    relative_path: ~
    file_type: txt
    configurations:
      - operation: replace
        current_value: "{$arg.existing-version}"
        new_value: "{$arg.new-version}"
  # analytics-worker - deployment.yaml
  - file_path: integrator-broker-analytics/analytics-worker/conf/worker/deployment.yaml
    relative_path: "{$arg.wso2ei}/wso2/analytics/conf/worker/deployment.yaml"
    file_type: yaml
    configurations:
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/jdbcUrl"
        value: "jdbc:mysql://172.28.128.3:3306/WSO2_EI_ANALYTICS_DB?useSSL=false"
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/username"
        value: "root"
      - operation: replace
        xpath: "wso2.datasources/dataSources[name=\"EI_ANALYTICS\"]/definition/configuration/driverClassName"
        value: "com.mysql.cj.jdbc.Driver"
  # broker - product_provisioner.sh
  - file_path: integrator-broker-analytics/broker/provisioner/product_provisioner.sh
    relative_path: ~
    file_type: txt
    configurations:
      - operation: replace
        current_value: "{$arg.existing-version}"
        new_value: "{$arg.new-version}"
  # broker.xml
  - file_path: iintegrator-broker-analytics/broker/conf/broker.xml
    relative_path: "{$arg.wso2ei}/wso2/broker/conf/broker.xml"
    file_type: xml
    configurations:
      - operation: replace
        xpath: "coordination/thriftServerHost"
        value: "172.28.128.5"
      - operation: replace
        xpath: "coordination/thriftServerPort"
        value: "7614"
  # carbon.xml
  - file_path: integrator-broker-analytics/broker/conf/carbon.xml
    relative_path: "{$arg.wso2ei}/wso2/broker/conf/carbon.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "."
        value:
          |
          <HostName>172.28.128.6</HostName>
      - operation: add
        xpath: "."
        value:
          |
          <MgtHostName>172.28.128.7</MgtHostName>
  # registry.xml
  - file_path: integrator-broker-analytics/broker/conf/registry.xml
    relative_path: "{$arg.wso2ei}/wso2/broker/conf/registry.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "."
        value:
          |
          <dbConfig name="WSO2_REGISTRY_DB">
            <dataSource>jdbc/WSO2_REGISTRY_DB</dataSource>
          </dbConfig>
      - operation: add
        xpath: "."
        value:
          |
          <remoteInstance url="https://localhost:8243/registry">
            <id>WSO2_REGISTRY_DB</id>
            <dbConfig>WSO2_REGISTRY_DB</dbConfig>
            <readOnly>false</readOnly>
            <registryRoot>/</registryRoot>
            <enableCache>true</enableCache>
            <cacheId>root@jdbc:mysql://172.28.128.3:3306/WSO2_REGISTRY_DB</cacheId>
          </remoteInstance>
      - operation: add
        xpath: "."
        value:
          |
          <mount path="/_system/config" overwrite="virtual">
            <instanceId>WSO2_REGISTRY_DB</instanceId>
            <targetPath>/_system/config/broker</targetPath>
          </mount>
      - operation: add
        xpath: "."
        value:
          |
          <mount path="/_system/governance" overwrite="virtual">
            <instanceId>WSO2_REGISTRY_DB</instanceId>
            <targetPath>/_system/governance</targetPath>
          </mount>
      - operation: replace
        xpath: "indexingConfiguration/startIndexing"
        value: "true"
  # user-mgt.xml
  - file_path: integrator-broker-analytics/broker/conf/user-mgt.xml
    relative_path: "{$arg.wso2ei}/wso2/broker/conf/user-mgt.xml"
    file_type: xml
    configurations:
      - operation: replace
        xpath: "Realm/Configuration/Property[@name=\"dataSource\"]"
        value: "jdbc/WSO2_USER_DB"
  # master-datasources.xml
  - file_path: integrator-broker-analytics/broker/conf/datasources/master-datasources.xml
    relative_path: "{$arg.wso2ei}/wso2/broker/conf/datasources/master-datasources.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "datasources"
        value:
          |
          <datasource>
            <name>WSO2_REGISTRY_DB</name>
            <description>The datasource is used for registry metadata</description>
            <jndiConfig>
                <name>jdbc/WSO2_REGISTRY_DB</name>
            </jndiConfig>
            <definition type="RDBMS">
              <configuration>
                <url>jdbc:mysql://172.28.128.3:3306/WSO2_REGISTRY_DB?autoReconnect=true&amp;useSSL=false</url>
                <username>root</username>
                <password>wso2carbon</password>
                <driverClassName>com.mysql.cj.jdbc.Driver</driverClassName>
                <maxActive>50</maxActive>
                <maxWait>60000</maxWait>
                <testOnBorrow>true</testOnBorrow>
                <validationQuery>SELECT 1</validationQuery>
                <validationInterval>30000</validationInterval>
              </configuration>
            </definition>
          </datasource>
      - operation: add
        xpath: "datasources"
        value:
          |
          <datasource>
            <name>WSO2_USER_DB</name>
            <description>The datasource is used for user mangement and userstore</description>
            <jndiConfig>
                <name>jdbc/WSO2_USER_DB</name>
            </jndiConfig>
            <definition type="RDBMS">
              <configuration>
                <url>jdbc:mysql://172.28.128.3:3306/WSO2_USER_DB?autoReconnect=true&amp;useSSL=false</url>
                <username>root</username>
                <password>wso2carbon</password>
                <driverClassName>com.mysql.cj.jdbc.Driver</driverClassName>
                <maxActive>50</maxActive>
                <maxWait>60000</maxWait>
                <testOnBorrow>true</testOnBorrow>
                <validationQuery>SELECT 1</validationQuery>
                <validationInterval>30000</validationInterval>
              </configuration>
            </definition>
          </datasource>
  # integrator-broker-analytics - product_provisioner.sh
  - file_path: integrator-broker-analytics/integrator/provisioner/product_provisioner.sh
    relative_path: ~
    file_type: txt
    configurations:
      - operation: replace
        current_value: "{$arg.existing-version}"
        new_value: "{$arg.new-version}"
  # carbon.xml
  - file_path: integrator-broker-analytics/integrator/conf/carbon.xml
    relative_path: "{$arg.wso2ei}/conf/carbon.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "."
        value:
          |
          <HostName>172.28.128.7</HostName>
      - operation: add
        xpath: "."
        value:
          |
          <MgtHostName>172.28.128.7</MgtHostName>
      - operation: replace
        xpath: "Analytics/ServerURL"
        value: "tcp://172.28.128.4:7612"
      - operation: replace
        xpath: "Analytics/AuthServerURL"
        value: "ssl://172.28.128.4:7712"
  # registry.xml
  - file_path: integrator-broker-analytics/integrator/conf/registry.xml
    relative_path: "{$arg.wso2ei}/conf/registry.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "."
        value:
          |
          <dbConfig name="WSO2_REGISTRY_DB">
            <dataSource>jdbc/WSO2_REGISTRY_DB</dataSource>
          </dbConfig>
      - operation: add
        xpath: "."
        value:
          |
          <remoteInstance url="https://localhost:8243/registry">
            <id>WSO2_REGISTRY_DB</id>
            <dbConfig>WSO2_REGISTRY_DB</dbConfig>
            <readOnly>false</readOnly>
            <registryRoot>/</registryRoot>
            <enableCache>true</enableCache>
            <cacheId>root@jdbc:mysql://172.28.128.3:3306/WSO2_REGISTRY_DB</cacheId>
          </remoteInstance>
      - operation: add
        xpath: "."
        value:
          |
          <mount path="/_system/config" overwrite="virtual">
            <instanceId>WSO2_REGISTRY_DB</instanceId>
            <targetPath>/_system/integrator/config</targetPath>
          </mount>
      - operation: add
        xpath: "."
        value:
          |
          <mount path="/_system/governance" overwrite="virtual">
            <instanceId>WSO2_REGISTRY_DB</instanceId>
            <targetPath>/_system/governance</targetPath>
          </mount>
      - operation: replace
        xpath: "indexingConfiguration/startIndexing"
        value: "true"
  # user-mgt.xml
  - file_path: integrator-broker-analytics/integrator/conf/user-mgt.xml
    relative_path: "{$arg.wso2ei}/conf/user-mgt.xml"
    file_type: xml
    configurations:
      - operation: replace
        xpath: "Realm/Configuration/Property[@name=\"dataSource\"]"
        value: "jdbc/WSO2_USER_DB"
  # synapse.properties
  - file_path: integrator-broker-analytics/integrator/conf/synapse.properties
    file_type: txt
    relative_path: "{$arg.wso2ei}/conf/synapse.properties"
    configurations:
      - operation: replace
        current_value: "mediation.flow.statistics.enable=false"
        new_value: "mediation.flow.statistics.enable=true"
      - operation: replace
        current_value: "mediation.flow.statistics.tracer.collect.payloads=false"
        new_value: "mediation.flow.statistics.tracer.collect.payloads=true"
      - operation: replace
        current_value: "mediation.flow.statistics.tracer.collect.properties=false"
        new_value: "mediation.flow.statistics.tracer.collect.properties=true"
      - operation: replace
        current_value: "mediation.flow.statistics.collect.all=false"
        new_value: "mediation.flow.statistics.collect.all=true"
  # axis2.xml
  - file_path: integrator-broker-analytics/integrator/conf/axis2/axis2.xml
    relative_path: "{$arg.wso2ei}/conf/axis2/axis2.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "transportReceiver[@name=\"http\"]"
        value:
          |
          <parameter name="WSDLEPRPrefix" locked="false">http://172.28.128.7:8280</parameter>
      - operation: add
        xpath: "transportReceiver[@name=\"https\"]"
        value:
          |
          <parameter name="WSDLEPRPrefix" locked="false">http://172.28.128.7:8243</parameter>
      - operation: add
        xpath: "."
        value:
            |
         <transportReceiver name="jms" class="org.apache.axis2.transport.jms.JMSListener">
          <parameter name="myTopicConnectionFactory" locked="false">
            <parameter name="java.naming.factory.initial" locked="false">org.wso2.andes.jndi.PropertiesFileInitialContextFactory</parameter>
            <parameter name="java.naming.provider.url" locked="false">conf/jndi.properties</parameter>
            <parameter name="transport.jms.ConnectionFactoryJNDIName" locked="false">TopicConnectionFactory</parameter>
            <parameter name="transport.jms.ConnectionFactoryType" locked="false">topic</parameter>
          </parameter>
          <parameter name="myQueueConnectionFactory" locked="false">
           <parameter name="java.naming.factory.initial" locked="false">org.wso2.andes.jndi.PropertiesFileInitialContextFactory</parameter>
           <parameter name="java.naming.provider.url" locked="false">conf/jndi.properties</parameter>
           <parameter name="transport.jms.ConnectionFactoryJNDIName" locked="false">QueueConnectionFactory</parameter>
           <parameter name="transport.jms.ConnectionFactoryType" locked="false">queue</parameter>
          </parameter>
          <parameter name="default" locked="false">
            <parameter name="java.naming.factory.initial" locked="false">org.wso2.andes.jndi.PropertiesFileInitialContextFactory</parameter>
            <parameter name="java.naming.provider.url" locked="false">conf/jndi.properties</parameter>
            <parameter name="transport.jms.ConnectionFactoryJNDIName" locked="false">QueueConnectionFactory</parameter>
            <parameter name="transport.jms.ConnectionFactoryType" locked="false">queue</parameter>
          </parameter>
         </transportReceiver>
      - operation: add
        xpath: "."
        value: |
          <transportSender name="jms" class="org.apache.axis2.transport.jms.JMSSender"/>
  - file_path: "integrator-broker-analytics/integrator/conf/jndi.properties"
    relative_path: "{$arg.wso2ei}/conf/jndi.properties"
    file_type: "txt"
    configurations:
      - operation: replace_line
        current_value: "connectionfactory.QueueConnectionFactory = amqp://admin:admin@clientID/carbon?brokerlist='tcp://localhost:5675'"
        new_value: "connectionfactory.QueueConnectionFactory = amqp://admin:admin@clientID/carbon?brokerlist='tcp://172.28.128.5:5675?retries='5'&connectdelay='50''"
      - operation: replace_line
        current_value: "connectionfactory.TopicConnectionFactory = amqp://admin:admin@clientID/carbon?brokerlist='tcp://localhost:5675'"
        new_value: "connectionfactory.TopicConnectionFactory = amqp://admin:admin@clientID/carbon?brokerlist='tcp://172.28.128.5:5675?retries='5'&connectdelay='50''"
  # master-datasources.xml
  - file_path: integrator-broker-analytics/integrator/conf/datasources/master-datasources.xml
    relative_path: "{$arg.wso2ei}/conf/datasources/master-datasources.xml"
    file_type: xml
    configurations:
      - operation: add
        xpath: "datasources"
        value:
          |
          <datasource>
            <name>WSO2_REGISTRY_DB</name>
            <description>The datasource is used for registry metadata</description>
            <jndiConfig>
              <name>jdbc/WSO2_REGISTRY_DB</name>
            </jndiConfig>
            <definition type="RDBMS">
              <configuration>
                <url>jdbc:mysql://172.28.128.3:3306/WSO2_REGISTRY_DB?autoReconnect=true&amp;useSSL=false</url>
                <username>root</username>
                <password>wso2carbon</password>
                <driverClassName>com.mysql.cj.jdbc.Driver</driverClassName>
                <maxActive>80</maxActive>
                <maxWait>60000</maxWait>
                <testOnBorrow>true</testOnBorrow>
                <validationQuery>SELECT 1</validationQuery>
                <validationInterval>30000</validationInterval>
              </configuration>
            </definition>
          </datasource>
      - operation: add
        xpath: "datasources"
        value:
          |
          <datasource>
            <name>WSO2_USER_DB</name>
            <description>The datasource is used for user mangement and userstore</description>
            <jndiConfig>
              <name>jdbc/WSO2_USER_DB</name>
            </jndiConfig>
            <definition type="RDBMS">
              <configuration>
                <url>jdbc:mysql://172.28.128.3:3306/WSO2_USER_DB?autoReconnect=true&amp;useSSL=false</url>
                <username>root</username>
                <password>wso2carbon</password>
                <driverClassName>com.mysql.cj.jdbc.Driver</driverClassName>
                <maxActive>50</maxActive>
                <maxWait>60000</maxWait>
                <testOnBorrow>true</testOnBorrow>
                <validationQuery>SELECT 1</validationQuery>
                <validationInterval>30000</validationInterval>
              </configuration>
            </definition>
          </datasource>
